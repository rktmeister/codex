---
source: core/src/compact.rs
expression: "context_snapshot::format_labeled_items_snapshot(\"When compaction output has multiple summary-only user messages and no real user message, canonical context is reinserted above the last summary.\",\n&[(\"Refreshed History Layout\", refreshed_items.as_slice())],\n&ContextSnapshotOptions::default().render_mode(ContextSnapshotRenderMode::KindWithTextPrefix\n{ max_chars: 64 }),)"
---
Scenario: When compaction output has multiple summary-only user messages and no real user message, canonical context is reinserted above the last summary.

## Refreshed History Layout
00:message/user:<COMPACTION_SUMMARY>\nolder summary
01:message/developer:fresh permissions
02:message/user:<COMPACTION_SUMMARY>\nlatest summary
